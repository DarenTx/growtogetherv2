# Plan: Admin Pages with Route Guard

**TL;DR** — Create three admin feature components under `src/app/features/admin/`, wire them into `app.routes.ts` behind the existing `adminGuard`, extend `SupabaseService` with two new methods, surface conditional admin nav links in the dashboard, and produce the required requirements markdown. A schema migration (Step 0) drops the FK from `profiles.id` so profiles can be inserted as placeholders now, with real auth user onboarding deferred to a later phase.

---

## Steps

### 0. Schema migration — drop FK from `profiles.id`

- **Why**: `profiles.id` is currently `REFERENCES auth.users(id) ON DELETE CASCADE`, which blocks inserting a profile row without a backing auth user. We are in data-entry mode now and will onboard users (create their auth accounts) in a future phase.
- **Change**: Alter `profiles.id` to a plain `UUID PRIMARY KEY DEFAULT gen_random_uuid()` with no FK constraint. Update `src/docs/Master Supabase Schema.sql` to reflect this.
- **Future onboarding** (out of scope for this phase): When ready to onboard a placeholder profile, call a Supabase Edge Function (using the service-role key server-side) that calls `supabase.auth.admin.inviteUserByEmail()`, then updates `profiles.id` to match the returned auth UUID. No service-role key is ever exposed in the browser.
- **Impact on `growth_data`**: `growth_data.user_id` remains a nullable FK to `auth.users(id)`. For placeholder profiles (no auth user yet), `user_id` will be inserted as `null`. The `email_key` field carries the profile association instead.

### 1. Add admin child routes in `src/app/app.routes.ts`

- Add a `/admin` parent route guarded by `adminGuard` (already implemented at `src/app/core/guards/admin.guard.ts`, currently unused)
- Add three lazy-loaded child routes:
  - `profiles` → `EnterProfilesComponent`
  - `market-data` → `EnterMarketDataComponent`
  - `historical-data` → `EnterHistoricalDataComponent`

### 2. Extend SupabaseService in `src/app/core/services/supabase.service.ts`

- Add `getAllProfiles(): Promise<Profile[]>` — selects all rows from `profiles` (no filter), used for the historical data dropdown
- Add `adminCreateProfile(data: { first_name, last_name, email }): Promise<void>` — direct Supabase `.insert()` into `profiles`. No RPC or Edge Function needed. Boolean fields (`email_verified`, `phone_verified`, `is_admin`, `registration_complete`) are omitted from the call and default to `false` in the DB. `id` is auto-generated by `gen_random_uuid()` after the Step 0 schema migration.

### 3. Create `EnterProfilesComponent` at `src/app/features/admin/enter-profiles/`

- Form fields: First Name (text), Last Name (text), Email (email)
- On submit: call `supabase.adminCreateProfile()`, clear the form on success
- Boolean fields (`email_verified`, `phone_verified`, `is_admin`, `registration_complete`) are NOT shown — they default to `false` in the DB
- Show inline success/error feedback

### 4. Create `EnterMarketDataComponent` at `src/app/features/admin/enter-market-data/`

- Form fields: Index Name (text, maps to `index_name`), Year (number), Month (number 1–12), Growth Percent (decimal, maps to `growth_pct`)
- On submit: call existing `supabase.saveMarketIndex()`, clear form on success
- Show inline success/error feedback

### 5. Create `EnterHistoricalDataComponent` at `src/app/features/admin/enter-historical-data/`

- On init: load all profiles via new `getAllProfiles()` to populate dropdown
- Form fields: Profile (select dropdown showing `first_name last_name — email`, value = profile `id`), Year (number), Month (number 1–12), Bank Name (text), Is Managed (checkbox/toggle), Growth Percent (decimal)
- On profile selection: `email_key` is set from the selected profile's `email`; `user_id` is set to `null` (placeholder profiles have no auth user yet)
- On submit: call existing `supabase.saveGrowthData()` with `user_id: null` and `email_key` from the selected profile, clear form on success
- Show inline success/error feedback

### 6. Update dashboard `src/app/features/dashboard/dashboard.component.ts` and `.html`

- The component already holds a `profile` signal; add `isAdmin = computed(() => this.profile()?.is_admin ?? false)`
- In the template, use `@if (isAdmin())` to conditionally render three `RouterLink` navigation links to `/admin/profiles`, `/admin/market-data`, and `/admin/historical-data`
- Import `RouterLink` into the component's `imports` array

### 7. Write requirements markdown at `src/docs/Admin Pages Requirements.md`

- Covers purpose, route paths, guard behavior, all form fields per page (with data types, defaults, validation rules), service methods used
- Documents the schema migration (Step 0) and the deferred onboarding approach (Edge Function, out of scope)
- Notes that `growth_data.user_id` will be `null` for placeholder profiles until onboarding is complete

---

## Verification

- Navigate to `/admin/profiles` as a non-admin → should redirect to `/dashboard`
- Navigate to `/admin/profiles` as an admin → form renders
- Submit each form with valid data → success message, form clears
- Submit with invalid data (e.g. month = 13) → validation errors shown
- Dashboard: logged in as non-admin → no admin links visible; logged in as admin → three links visible

---

## Decisions

- `index_name` is a free-text field (e.g. `'S&P 500'`), not a numeric value
- **Profile creation approach**: Option C + E hybrid — drop the FK from `profiles.id` now (schema migration) and use a direct Supabase insert. When ready to onboard users, a future Edge Function (Option E) will create the auth user and link it. No service-role key is ever exposed in the browser.
- `adminCreateProfile()` is a direct `.insert()` call — no RPC, no Edge Function required in this phase
- `growth_data.user_id` is inserted as `null` for placeholder profiles; `email_key` carries the profile association
- Historical data dropdown shows **all** profiles regardless of `registration_complete`
- Future onboarding Edge Function is explicitly **out of scope** for this phase
